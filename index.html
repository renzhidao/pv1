<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0e0f13" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <title>P1 éšç§˜ç½‘ç»œ</title>
  <style>
    :root { --bg:#0e0f13; --panel:#13151b; --line:#232634; --text:#e6e6e6; --sub:#8ea0b8; --primary:#2a7cff; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; }
    
    .sidebar { width:280px; background:#0b0d12; border-right:1px solid var(--line); display:flex; flex-direction:column; z-index:2; transition:.3s; }
    .my-card { padding:15px; background:#0e1016; border-bottom:1px solid var(--line); }
    .my-info { display:flex; align-items:center; gap:10px; }
    .avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#2a7cff,#00c6ff); display:grid; place-items:center; font-weight:bold; color:#fff; flex-shrink:0; }
    .status-row { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--sub); margin-top:4px; }
    .dot { width:8px; height:8px; border-radius:50%; background:#666; }
    .dot.online { background:#22c55e; box-shadow:0 0 5px #22c55e; }
    
    .contact-list { flex:1; overflow-y:auto; padding:8px; }
    .contact-item { display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; margin-bottom:4px; cursor:pointer; }
    .contact-item.active { background:#1f232e; }
    .c-name { font-size:14px; font-weight:500; color:#fff; }
    .c-status { font-size:11px; color:#555; }
    
    .main-chat { flex:1; display:flex; flex-direction:column; background:var(--bg); position:relative; min-width:0; }
    .header { height:54px; border-bottom:1px solid var(--line); display:flex; align-items:center; padding:0 15px; justify-content:space-between; background:var(--panel); }
    .btn-icon { font-size:20px; padding:5px; cursor:pointer; }
    
    .msgs { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
    .msg-row { display:flex; flex-direction:column; max-width:80%; }
    .msg-row.me { align-self:flex-end; align-items:flex-end; }
    .msg-row.other { align-self:flex-start; align-items:flex-start; }
    .bubble { padding:8px 12px; border-radius:12px; font-size:15px; line-height:1.4; word-wrap:break-word; }
    .me .bubble { background:var(--primary); color:#fff; border-bottom-right-radius:2px; }
    .other .bubble { background:#23262f; border-bottom-left-radius:2px; }
    .meta { font-size:10px; opacity:0.5; margin-top:2px; }
    .sys { align-self:center; background:rgba(255,255,255,0.05); padding:2px 10px; border-radius:10px; font-size:11px; color:#888; }
    
    .send-area { padding:10px; background:var(--panel); border-top:1px solid var(--line); display:flex; gap:10px; align-items:flex-end; }
    #editor { flex:1; background:#0a0c10; border:1px solid #2b3040; border-radius:8px; padding:10px; max-height:100px; overflow-y:auto; }
    #btnSend { padding:0 15px; height:40px; border-radius:8px; background:var(--primary); border:none; color:#fff; font-weight:bold; }
    
    .file-card { background:rgba(0,0,0,0.3); padding:8px; border-radius:5px; display:flex; align-items:center; gap:8px; }
    .file-btn { background:#2a7cff; color:#fff; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:12px; }
    .red-dot { display:inline-block; width:8px; height:8px; background:#f00; border-radius:50%; margin-left:5px; }

    #miniLog { position:fixed; bottom:70px; left:10px; font-size:10px; color:#0f0; opacity:0.5; pointer-events:none; white-space:pre-wrap; }
    #settings { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:99; display:none; place-items:center; }
    .box { width:80%; max-width:300px; background:#1a1d24; padding:20px; border-radius:10px; }
    .ipt { width:100%; padding:10px; margin-bottom:10px; background:#000; border:1px solid #333; color:#fff; }
    
    @media(max-width:768px) {
      .sidebar { position:absolute; height:100%; width:100%; transform:translateX(0); }
      .sidebar.hidden { transform:translateX(-100%); }
      .mobile-back { display:block !important; margin-right:10px; }
    }
    .mobile-back { display:none; }
  </style>
</head>
<body>

<div class="app-shell">
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="my-card">
      <div class="my-info">
        <div class="avatar" id="myAvatar">æˆ‘</div>
        <div style="flex:1">
          <div id="myNick" style="font-weight:bold">-</div>
          <div class="status-row"><div class="dot" id="statusDot"></div><span id="statusText">ç¦»çº¿</span></div>
        </div>
        <div class="btn-icon" id="btnSet">âš™ï¸</div>
      </div>
      <div style="font-size:11px; color:#555; margin-top:5px">ID: <span id="myId">...</span></div>
    </div>
    <div class="contact-list" id="contactList"></div>
  </div>

  <!-- èŠå¤©çª—å£ -->
  <div class="main-chat">
    <div class="header">
      <div style="display:flex;align-items:center">
        <div class="btn-icon mobile-back" id="btnBack">â†</div>
        <div id="chatTitle" style="font-weight:bold">å…¬å…±é¢‘é“</div>
      </div>
      <div class="btn-icon" id="btnInstall" style="display:none">ğŸ“²</div>
    </div>
    
    <div class="msgs" id="msgList"></div>
    
    <div class="send-area">
      <div class="btn-icon" id="btnFile">ğŸ“</div>
      <div id="editor" contenteditable="true"></div>
      <button id="btnSend">å‘é€</button>
    </div>
    <input type="file" id="fileInput" style="display:none">
    <div id="miniLog"></div>
  </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div id="settings">
  <div class="box">
    <h3>è®¾ç½®</h3>
    <input class="ipt" id="iptNick" placeholder="æ˜µç§°">
    <input class="ipt" id="iptPeer" placeholder="æ·»åŠ èŠ‚ç‚¹ID">
    <button id="btnSave" style="width:100%;padding:10px;background:#2a7cff;border:none;color:#fff">ä¿å­˜</button>
    <button id="btnClose" style="width:100%;padding:10px;background:none;border:none;color:#666">å–æ¶ˆ</button>
  </div>
</div>

<!-- è„šæœ¬ -->
<script>
  // å…¨å±€é”™è¯¯æ•è·
  window.onerror = function(msg, url, line) {
    alert('è¿è¡Œé”™è¯¯: ' + msg + '\nè¡Œå·: ' + line);
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>
<script src="easytier.js"></script>
<script>if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');</script>
</body>
</html>