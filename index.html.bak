<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>P2P å›ºå®šå…¥å£ + èŠå¤©</title>
  <style>
    /* å…¥å£é¡µæ ·å¼ */
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans','PingFang SC','Microsoft YaHei',sans-serif;background:#0f1115;color:#e6e6e6}
    .wrap{max-width:980px;margin:30px auto;padding:16px}
    .card{border:1px solid #232634;border-radius:12px;padding:16px;background:#0b0d12}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .row input[type=text]{flex:1;min-width:180px;padding:10px;border:1px solid #2b3040;border-radius:8px;background:#0f1320;color:#d7e1f2}
    .btn{padding:10px 14px;border:1px solid #3a4660;border-radius:8px;background:#2a7cff;color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1a2234;color:#d7e1f2}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{padding:4px 10px;border-radius:999px;border:1px solid #2a3142;background:#0e1422;color:#a9c6ff;font-size:12px}
    .box{border:1px solid #232634;border-radius:10px;padding:12px;background:#0a0c10;margin-top:12px}
    .muted{color:#9aa7b4;font-size:12px}
    .log{margin-top:12px;background:#0a0c10;border:1px solid #232634;border-radius:10px;padding:10px;height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;color:#9fe3a6}
    .vid{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    video{max-width:380px;background:#000;border-radius:8px}
    .qr{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .qr-wrap{display:inline-block;background:#ffffff;padding:16px;border-radius:10px;border:1px solid #e5e5e5}
    #qr{width:256px;height:256px}
    /* åµŒå…¥èŠå¤©å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œç”±â€œæ‰“å¼€UIâ€æŒ‰é’®æ˜¾ç¤ºï¼›â€œå…æ‰“æ‰°â€ä¹Ÿä¼šéšè—è¿™é‡Œ */
    #classicHost{display:none;margin-top:20px}
  </style>

  <!-- èŠå¤© UIï¼ˆclassicï¼‰æ ·å¼ï¼šä¿®å¤ .chip çš„ border å†’å·é”™è¯¯ -->
  <style>
    :root{
      --sidebar-fr: 0.28; --header-fr: 0.10; --send-fr: 0.18;
      --bg: #0e0f13; --panel: #0b0d12; --fg: #e6e6e6; --muted: #9aa7b4; --line: rgba(255,255,255,.08);
      --input-bg: #0a1120; --input-border: #2d3649; --chip: #0d1526; --chip-border: #2e3648; --btn-bg: #1a2234; --btn-border: #354059; --primary: #2a7cff; --thumb: 160px;
    }
    *{ box-sizing: border-box; }
    .shell{ width:100dvw; height:100dvh; margin:0; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif,-apple-system,system-ui,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,"Noto Sans","Hiragino Sans GB",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; border-radius:12px; overflow:hidden;
    }
    .app{
      width:100%; height:100%;
      display:grid;
      grid-template-columns: calc(var(--sidebar-fr) * 100%) calc((1 - var(--sidebar-fr)) * 100%);
      grid-template-rows: calc(var(--header-fr) * 100%) calc((1 - var(--header-fr) - var(--send-fr)) * 100%) calc(var(--send-fr) * 100%);
      gap:10px; padding:10px;
    }
    .sidebar{
      grid-column:1; grid-row:1 / span 3;
      background:var(--panel); border:1px solid var(--line); border-radius:12px;
      display:grid; grid-template-rows:auto 1fr; overflow:hidden; min-width:0; min-height:0;
    }
    .sidebar .search{ padding:10px; border-bottom:1px solid var(--line); background:#0c1018; }
    .sidebar .search input{
      width:100%; height:40px; font-size:14px; background:#0f1320; color:#d7e1f2;
      border:1px solid #32394a; border-radius:8px; padding:8px 12px; outline:none;
    }
    .sidebar .list{ padding:10px; overflow:auto; }
    .contact{
      display:grid; grid-template-columns:36px 1fr; gap:8px; align-items:center;
      padding:8px; border:1px solid #232a3a; background:#0e1422; border-radius:10px; margin-bottom:8px; cursor:pointer;
    }
    .contact.active{ border-color:#3b82f6; background:#0d1526; }
    .avatar{ width:36px; height:36px; border-radius:50%; background: linear-gradient(135deg,#5aa1ff,#7ce3ff); }
    .cname{ font-size:13px; color:#cfe3ff; }
    .cmsg{ font-size:12px; color:#8ea0b8; }

    .header{
      grid-column:2; grid-row:1;
      background:var(--panel); border:1px solid var(--line); border-radius:12px;
      display:flex; align-items:center; gap:8px; padding:0 12px; overflow:hidden; min-width:0;
    }
    .chip{ padding:4px 10px; border-radius:999px; font-size:12px; background:var(--chip); border:1px solid var(--chip-border); color:#a9c6ff; white-space:nowrap; cursor:default; }

    .messages{
      grid-column:2; grid-row:2;
      background:var(--panel); border:1px solid var(--line); border-radius:12px;
      padding:10px; display:grid; grid-template-rows:1fr; min-height:0; min-width:0;
    }
    .msg-scroll{ overflow:auto; display:grid; grid-auto-rows:min-content; gap:8px; padding-right:4px; }
    .row{ display:flex; gap:8px; align-items:flex-end; }
    .row.right{ justify-content:flex-end; }
    .bubble{
      max-width:72%; padding:8px 10px; border-radius:12px; font-size:14px; line-height:1.35;
      border:1px solid #2a3142; background:#0f1726; color:#dce8ff; word-break:break-word; min-width:0;
    }
    .bubble.me{ background:#163244; border-color:#23465f; }
    .bubble.file{ background:#0f1c2e; color:#cfe3ff; padding:8px 10px; max-width:280px; }
    .bubble.media{ background:transparent; border:none; padding:0; }
    .file-link{ text-decoration:none; color:inherit; display:block; }
    .file-info{ display:flex; align-items:center; gap:8px; min-width:0; }
    .file-icon{ font-size:24px; flex-shrink:0; }
    .file-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .progress-line{ margin-top:4px; font-size:12px; color:#8ea0b8; }

    .thumb-link{ display:inline-block; text-decoration:none; }
    .thumb.img{ width: var(--thumb); height:auto; display:block; border-radius:8px; }
    .thumb.video{ position:relative; width:var(--thumb); border-radius:8px; overflow:hidden; background:#0f1726 center/cover no-repeat; }
    .thumb.video::before{ content:''; display:block; padding-top:56.25%; }
    .thumb.video .play{
      position:absolute; inset:0; display:grid; place-items:center;
      color:#fff; font-size:28px; text-shadow:0 3px 12px rgba(0,0,0,.6);
    }

    .avatar-sm{
      width:28px; height:28px; border-radius:50%;
      display:grid; place-items:center; background: linear-gradient(135deg,#5aa1ff,#7ce3ff);
      flex:0 0 28px; overflow:hidden;
    }
    .avatar-sm .letter{ color:#fff; font-weight:700; font-size:12px; user-select:none; line-height:1; }

    .send{
      grid-column:2; grid-row:3;
      background:var(--input-bg); border:1px solid #2d3649; border-radius:12px;
      display:grid; grid-template-columns:auto 1fr auto; grid-template-rows:1fr auto; min-width:0; min-height:0;
    }
    .editor{
      grid-column:1 / -1; grid-row:1;
      background:transparent; color:#e5efff; line-height:1.35; font-size:14px;
      outline:none; white-space:pre-wrap; word-break:break-word; overflow:auto; padding:10px;
    }
    .editor:empty:before{ content: attr(data-ph); color: var(--muted); pointer-events:none; }
    .s-left{ grid-column:1; grid-row:2; display:flex; gap:10px; align-items:center; padding:10px; }
    .s-actions{ grid-column:3; grid-row:2; display:flex; gap:10px; align-items:center; padding:10px; }
    .icon{
      display:inline-grid; place-items:center; width:38px; height:38px; border-radius:10px;
      background:#1a2234; border:1px solid #354059; color:#d8e6ff; font-size:18px; cursor:pointer; user-select:none; flex:0 0 38px;
    }
    .icon input[type=file]{ display:none; }
    .btn{ padding:8px 14px; border-radius:10px; background:#1a2234; border:1px solid #354059; color:#d8e6ff; font-size:14px; cursor:pointer; }
    .btn.primary{ background:#2a7cff; border-color:#2a7cff; color:#fff; }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .send.drag-over{ outline:2px dashed #2a7cff; outline-offset:-6px; }
    @media (max-width: 380px){
      .bubble{ font-size:13px; }
      .editor{ font-size:13px; }
    }

    /* è‡ªå®šä¹‰åª’ä½“å¡ç‰‡æ ·å¼ï¼ˆéŸ³é¢‘/è§†é¢‘ï¼‰ - å…¼å®¹æ—§å®ç°ï¼Œæ— éœ€åˆ é™¤ */
    .media-card{display:flex;flex-direction:column;gap:6px}
    .media-head{display:flex;align-items:center;gap:8px;min-width:0}
    .media-title{max-width:calc(var(--thumb) - 20px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#cfe3ff;font-size:13px}
    .media-note{margin-left:auto;color:#8ea0b8;font-size:12px}
    .media-ctrl{display:flex;align-items:center;gap:8px}
    .media-toggle{width:28px;height:28px;border-radius:8px;border:1px solid #354059;background:#1a2234;color:#d8e6ff;cursor:pointer}
    .media-seek{flex:1;appearance:none;height:4px;border-radius:999px;background:#2a3142;outline:none}
    .media-seek::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;background:#2a7cff;border:none;margin-top:-4px}
    .media-seek::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:#2a7cff;border:none}
    .media-time{min-width:84px;text-align:right;color:#8ea0b8;font-size:12px}

    /* é•¿æŒ‰å¤åˆ¶çš„è½»æç¤ºï¼ˆåˆ©ç”¨ data-copied å±æ€§ï¼‰ */
    [data-copied]:after{
      content: attr(data-copied);
      position:absolute; transform:translateY(-100%); margin-top:-6px;
      background:#1a2234; color:#cfe3ff; font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid #354059;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸš€ å›ºå®šå…¥å£ Â· P2P è¿æ¥é…ç½®</h1>
      <div class="muted">ç‚¹å‡»â€œæ‰“å¼€UIâ€åï¼ŒèŠå¤©ç•Œé¢ä¼šåœ¨å½“å‰é¡µé¢æ˜¾ç¤ºï¼›ç‚¹å‡»èŠå¤©å¤´éƒ¨çš„â€œå…æ‰“æ‰°â€å¯å®Œå…¨éšè—ã€‚</div>

      <div class="row">
        <input id="nickname" type="text" placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
        <input id="networkName" type="text" placeholder="ç½‘ç»œåï¼ˆå¯é€‰ï¼Œé»˜è®¤ public-networkï¼‰" />
      </div>

      <div class="row">
        <button id="connectBtn" class="btn">ğŸ”Œ è¿æ¥ç½‘ç»œ</button>
        <button id="openUI" class="btn secondary">ğŸ’¬ æ‰“å¼€UI</button>
        <button id="copyShare" class="btn secondary">ğŸ”— å¤åˆ¶æˆ‘çš„åˆ†äº«é“¾æ¥</button>
        <button id="copyLog" class="btn secondary">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
        <button id="clearLog" class="btn secondary">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        <button id="callBtn" class="btn secondary" disabled>ğŸ¥ å¿«é€Ÿè§†é¢‘é€šè¯</button>
      </div>

      <div class="chips">
        <span class="chip" id="entryStatusChip">çŠ¶æ€ï¼šç¦»çº¿</span>
        <span class="chip">åœ¨çº¿ <span id="peerCount">0</span></span>
        <span class="chip">æœ¬æœºID <span id="localId">-</span></span>
        <span class="chip">è™šæ‹ŸIP <span id="virtualIp">-</span></span>
        <span class="chip">åœ¨çº¿æ—¶é•¿ <span id="uptime">00:00:00</span></span>
      </div>

      <div id="share" class="box" style="display:none">
        <div class="qr">
          <div class="qr-wrap"><div id="qr"></div></div>
          <div>
            <div class="muted">åˆ†äº«ç»™å¥½å‹ï¼šç”¨é“¾æ¥æˆ–æ‰«ç ï¼Œæœ‹å‹æ‰“å¼€åè‡ªåŠ¨ä¸ä½ å»ºç«‹è¿æ¥</div>
            <div class="row"><input id="shareLink" type="text" readonly value="" style="min-width:360px" /></div>
          </div>
        </div>
      </div>

      <div class="log" id="log"></div>

      <div class="vid">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <!-- åµŒå…¥èŠå¤© UIï¼ˆé»˜è®¤éšè—ï¼Œé€šè¿‡â€œæ‰“å¼€UIâ€æ˜¾ç¤ºï¼›â€œå…æ‰“æ‰°â€å®Œå…¨éšè—ï¼‰ -->
    <div id="classicHost">
      <div class="shell">
        <div class="app">
          <aside class="sidebar" aria-label="è”ç³»äºº">
            <div class="search"><input id="contactSearch" placeholder="æœç´¢è”ç³»äºº" /></div>
            <div class="list" id="contactList"></div>
          </aside>

          <header class="header" aria-label="é¡¶éƒ¨æ ">
            <span class="chip" id="statusChip">æœªè¿æ¥</span>
            <span class="chip" id="onlineChip">åœ¨çº¿ 0</span>
            <span class="chip">èŠå¤©ä¸­</span>
            <span class="chip">å…æ‰“æ‰°</span>
            <span class="chip">ç¾¤è®¾ç½®</span>
          </header>

          <main class="messages" aria-label="æ¶ˆæ¯åˆ—è¡¨">
            <!-- ç¾¤èŠé»˜è®¤å®¹å™¨ï¼›å•èŠå®¹å™¨ç”± JS åŠ¨æ€åˆ›å»º -->
            <div id="msgScroll" class="msg-scroll"></div>
          </main>

          <section class="send" aria-label="å‘é€åŒº" id="sendArea">
            <div id="editor" class="editor" contenteditable="true" data-ph="è¾“å…¥æ¶ˆæ¯â€¦ å›è½¦å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></div>
            <div class="s-left">
              <button id="emojiBtn" class="icon" title="è¡¨æƒ…">ğŸ˜€</button>
              <label class="icon" title="é™„ä»¶">ğŸ“<input id="fileInput" type="file" multiple /></label>
            </div>
            <div class="s-actions">
              <button id="sendBtn" class="btn primary" disabled>å‘é€</button>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¾èµ–åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>

  <!-- é…ç½®æ³¨å…¥ï¼šä¸ easytier.js ä¿æŒä¸€è‡´ -->
  <script>
    // æœåŠ¡ä¸ç½‘ç»œåï¼ˆæŒ‰éœ€æ”¹ä¸ºä½ çš„ PeerJS/ä¿¡ä»¤æœåŠ¡å™¨ï¼‰
    window.FIXED_SERVER  = { host:'peerjs.92k.de', port:443, secure:true, path:'/' };
    window.FIXED_NETWORK = 'public-network';

    // å‘Šè¯‰è„šæœ¬æˆ‘ä»¬åœ¨â€œå…¥å£é¡µâ€ä¸”ä½¿ç”¨â€œç»å…¸ UIâ€
    window.__ENTRY_PAGE__ = true;
    window.CLASSIC_UI = true;

    // é»˜è®¤éšè—èŠå¤© UIï¼šä»…å½“ç”¨æˆ·ç‚¹å‡»â€œæ‰“å¼€UIâ€æ‰æ˜¾ç¤º
    try{
      if (localStorage.getItem('classicMuted') === null){
        localStorage.setItem('classicMuted','1');
      }
    }catch(e){}
  </script>

  <!-- ä¸»é€»è¾‘ï¼ˆä½¿ç”¨ä½ æ›¿æ¢è¿‡çš„æ–° easytier.jsï¼›ç¡®ä¿æœ¬ï¿½ï¿½ï¿½åªå¼•å…¥ä¸€æ¬¡ï¼‰ -->
  <script src="easytier.js"></script>

  <!-- å…¥å£é¡µè„šæœ¬ï¼šæŒ‰é’®è¡Œä¸ºã€çŠ¶æ€åŒæ­¥ã€å…æ‰“æ‰°æ—¶å®Œå…¨éšè—å®¹å™¨ + é˜²é—ªçƒ -->
  <script>
    const $ = s => document.querySelector(s);
    const logEl = $('#log');
    function log(s){ logEl.textContent += (logEl.textContent ? '\n' : '') + s; logEl.scrollTop = logEl.scrollHeight; }
    window._entryLog = log;

    // è¦†ç›– setMutedï¼šåœ¨åµŒå…¥æ¨¡å¼ä¸‹ï¼Œé™¤äº†éšè— .appï¼Œä¹Ÿéšè—æ•´ä¸ª #classicHost å®¹å™¨ï¼Œå®ç°â€œå®Œå…¨éšè—â€
    (function patchMuted(){
      function tryPatch(){
        if (!window.app || !app.setMuted) { setTimeout(tryPatch, 100); return; }
        var orig = app.setMuted;
        app.setMuted = function(flag){
          try{ orig.call(app, flag); }catch(e){}
          var host = document.getElementById('classicHost');
          if (host) host.style.display = flag ? 'none' : 'block';
        };
        // åˆå§‹è·Ÿéšæœ¬åœ°çŠ¶æ€
        try{
          var muted = localStorage.getItem('classicMuted') === '1';
          var host = document.getElementById('classicHost');
          if (host) host.style.display = muted ? 'none' : 'block';
        }catch(e){}
      }
      tryPatch();
    })();

    document.addEventListener('DOMContentLoaded', function(){
      const connectBtn = $('#connectBtn');
      const openUI     = $('#openUI');
      const copyShare  = $('#copyShare');
      const copyLogBtn = $('#copyLog');
      const clearLogBtn= $('#clearLog');
      const callBtn    = $('#callBtn');
      const nickIpt    = $('#nickname');

      const savedNick = localStorage.getItem('nickname') || '';
      if (savedNick) nickIpt.value = savedNick;

      connectBtn.addEventListener('click', ()=>{
        localStorage.setItem('nickname', (nickIpt.value||'').trim());
        if (window.app){
          // app.toggle å†…éƒ¨ä¼šè¯»å– #networkName çš„å€¼
          app.toggle();
        }
      });

      openUI.addEventListener('click', ()=>{
        // ä»…æ˜¾ç¤ºï¼Œå¹¶æ¸…é™¤å…æ‰“æ‰°çŠ¶æ€
        try{ localStorage.setItem('classicMuted','0'); }catch(e){}
        const host = document.getElementById('classicHost');
        if (host) host.style.display = 'block';
        if (window.app && app.showUI) app.showUI();
        if (host && host.scrollIntoView) host.scrollIntoView({behavior:'smooth', block:'start'});
      });

      copyShare.addEventListener('click', ()=> window.app && app.copyLink());
      copyLogBtn.addEventListener('click', ()=> window.app && app.copyLog());   // å¤åˆ¶â€œå…¨é‡æ—¥å¿—â€
      clearLogBtn.addEventListener('click', ()=> window.app && app.clearLog());
      callBtn.addEventListener('click', ()=> window.app && app.quickCall());    // å…¥å£é¡µç›´æ‹¨

      // å…¥å£é¡µçŠ¶æ€åŒæ­¥ï¼ˆä»…å˜æ›´æ‰æ›´æ–°ï¼Œé¿å…é—ªçƒï¼›uptime ä»æŒ‰ä¼ å…¥å€¼æ›´æ–°ï¼‰
      (function(){
        const last = { connected:null, online:null, localId:null, virtualIp:null };
        window.updateEntryStatus = function(state){
          const s = state || {};
          if (last.connected !== s.connected){
            $('#entryStatusChip').textContent = 'çŠ¶æ€ï¼š' + (s.connected ? 'åœ¨çº¿' : 'ç¦»çº¿');
            $('#share').style.display = s.connected ? 'block' : 'none';
            $('#callBtn').disabled = !s.connected;
            connectBtn.textContent = s.connected ? 'ğŸ”Œ æ–­å¼€' : 'ğŸ”Œ è¿æ¥ç½‘ç»œ';
            last.connected = s.connected;
          }
          if (last.online !== s.online){
            $('#peerCount').textContent = String(s.online || 0);
            last.online = s.online;
          }
          if (last.localId !== s.localId){
            $('#localId').textContent = s.localId || '-';
            last.localId = s.localId || '';
          }
          if (last.virtualIp !== s.virtualIp){
            $('#virtualIp').textContent = s.virtualIp || '-';
            last.virtualIp = s.virtualIp || '';
          }
          // uptime æ¯ç§’éƒ½ä¼šå˜åŒ–ï¼Œç›´æ¥æ›´æ–°å³å¯
          $('#uptime').textContent = s.uptime || '00:00:00';
        };
      })();

      // åˆå§‹é»˜è®¤éšè—èŠå¤© UIï¼ˆç”± localStorage æ§åˆ¶ï¼‰
      try{
        const host = document.getElementById('classicHost');
        const muted = localStorage.getItem('classicMuted') === '1';
        if (host) host.style.display = muted ? 'none' : 'block';
      }catch(e){}
    });

    window.addEventListener('beforeunload', function(e){
      if (window.app && app.isConnected) {
        e.preventDefault();
        e.returnValue = 'å…³é—­é¡µé¢å°†æ–­å¼€è¿æ¥ï¼Œç¡®å®šå—ï¼Ÿ';
      }
    });
  </script>
</body>
</html>